%source /etc/rwshrc-basic

# set up environment
%global BUILT_EXECUTABLE /bin/rwsh
%global ERRINFO ()
%global OLD_ERRNO ()
%global REGEX ()
%global s $HOME
%global s2 $HOME
%selection_set s /
%global TEMP1 ()
%global TEMP2 ()
%set FIGNORE .*

# selection commands
%function sfn {
  %function $* {%selection_set s $1; &&{%which_path &&1 $PATH} @$s}}
sfn cat 
%function cd {%selection_set s $1; %cd @$s; %selection_set s /; %set s2 $s}
%function chmod {%selection_set s $2; &{whichp chmod} $1 @$s}
%function cp {/bin/cp @$s $1}
%function create {&{whichp touch} $1; %selection_set s $1}
%function cvs {%selection_set s $2; &{whichp cvs} $1 @$s}
%function diff {
  %selection_set s $1; %selection_set s2 $2
  &{whichp diff} @$s @$s2}
%function du {%selection_set s $1; &{whichp du} -hsc @$s}
%function gdb {
  if_only %test_equal $# 2 {%set BUILT_EXECUTABLE &&*}
  &{whichp gdb} $BUILT_EXECUTABLE}
%function gdb-bash {
  if_only %test_equal $# 2 {%set BUILT_EXECUTABLE &&*}
  %set SHELL /bin/bash
  &{whichp gdb} $BUILT_EXECUTABLE
  %set SHELL /bin/rwsh}
%function grep {
  %set REGEX $1
  %selection_set s $2
  &{whichp grep} $REGEX @$s}
%function grepc {
  %set REGEX $1
  %selection_set s $2
  &{whichp grep} -c $REGEX @$s}
%function grepl {
  %set REGEX $1
  %selection_set s $2
  &{whichp grep} -l $REGEX @$s}
%function home {%set s $HOME; cd}
sfn head 
%function ignore {%set FIGNORE $*}
%function ll {%selection_set s $1; &{whichp ls} -l @$s}
%function mv {&{whichp mv} @$s $1}
%function ls {%selection_set s $1; %ls @$s}
sfn less 
%function oless {&{whichp less} $*}
%function regrep {
  %selection_set s $1
  &{whichp grep} $REGEX @$s}
%function regrepl {
  %selection_set s $1
  &{whichp grep} -l $REGEX @$s}
sfn rm 
sfn touch
sfn vi 
%function vim {
  %set SHELL /bin/bash
  %selection_set s $1
  /usr/bin/vim @$s
  %set SHELL /bin/rwsh}
%function ovim {
  %set SHELL /bin/bash
  /usr/bin/vim $*
  %set SHELL /bin/rwsh}
sfn wc 
%function unselect {%set s $CWD; %selection_set s /}

# internal functions
%function rwsh.after_command {
  %set TEMP1 $?
  %if_errno {
    %set OLD_ERRNO $ERRNO
    %unset ERRNO
    %if %test_equal $OLD_ERRNO ESUBSTITUTION {
      echo substitution $ERRINFO failed}
    %else {echo ERRNO is set to $OLD_ERRNO}}
  if_only_not %test_equal $TEMP1 0 {echo &&1 returned $TEMP1}}
%function rwsh.arguments_for_argfunction {
  %echo cannot specify arguments for $1 directly $nl
  %return -1}
%function rwsh.bad_argfunction_style {
  %echo $1 is neither an argfunction nor a substitution $nl
  %return -1}
%function rwsh.binary_not_found {
  %echo $1 : could not run binary $nl
  %return -1}
%function rwsh.double_redirection {
  %echo double redirection is not supported at this time: $1 and $2 $nl}
%function rwsh.excessive_nesting {
  %echo $nl function exceeded MAX_NESTING \( $MAX_NESTING \). call stack: $* $nl}
%function rwsh.failed_substitution {
  %append_to_errno ESUBSTITUTION
  %set ERRINFO $1}
%function rwsh.help {
  %echo this is the default configuration for rwsh (or something copied from it), documentation should be available at rwsh.sf.net $nl}
%function rwsh.mismatched_brace {
  %echo mismatched brace: $1 $nl
  %return -1}
%function rwsh.multiple_argfunctions {
  %echo multiple argfunctions not supported at this time $nl
  %return -1}
%function rwsh.not_soon_enough {
  %echo $1 attempts to substitute after the command has been run $nl
  %return -1}
%function rwsh.prompt {%echo $s; %echo \$}
%function rwsh.selection_not_found {
  %echo no file matching pattern $1
  if_only_not %test_equal $1 $2 {%echo () for selection &&2} $nl}
%function rwsh.shutdown {%echo $nl}
%function rwsh.sighup {%echo $nl received SIGHUP: $* $nl}
%function rwsh.sigint {%echo $nl received SIGINT: $* $nl}
%function rwsh.sigquit {%echo $nl received SIGQUIT: $* $nl}
%function rwsh.sigpipe {%echo $nl received SIGPIPE: $* $nl}
%function rwsh.sigterm {%echo $nl received SIGTERM: $* $nl}
%function rwsh.sigtstp {%echo $nl received SIGTSTP: $* $nl}
%function rwsh.siginfo {%echo $nl received SIGINFO: $* $nl}
%function rwsh.sigusr1 {%echo $nl received SIGUSR1: $* $nl}
%function rwsh.sigusr2 {%echo $nl received SIGUSR2: $* $nl}
%function rwsh.undefined_variable {
  %echo $1 was undefined with call stack $*2 $nl}
%function rwsh.unreadable_dir {%echo cannot read directory $1 $nl}
%function rwsh.vars {
  %internal_vars
  echo $nl ERRINFO $ERRINFO
  echo HOME $HOME
  echo OLDERRNO $OLDERRNO
  echo REGEX $REGEX
  echo s $s}

# misc
%function ! {if $* {%return 1}; else {%return 0}}
%function m {rwsh.argfunction}
%function and {%if %return 1; %stepwise $* {%else_if_not $*}; %else}
%function or {%if %return 1; %stepwise $* {%else_if $*}; %else}
%global TESTABILITY (an external variable)
%function st {/bin/rwsh /usr/share/rwsh/test_init.sh </usr/share/rwsh/test_main.sh >test.tmp
  /usr/bin/diff -c /usr/share/rwsh/test.result test.tmp
  /bin/rm test.tmp}
%function to {/bin/rwsh /usr/share/rwsh/test_init.sh </usr/share/rwsh/test_main.sh}
fn test_var_not_equal {%test_not_equal $$1 $2}
fn ntimes {
  %set TEMP1 0
  %while test_var_not_equal TEMP1 $1 {
    %var_add TEMP1 1
    rwsh.mapped_argfunction {rwsh.argfunction}}}

# final setup and individual configuration
%global rc $HOME 
%selection_set rc /.rwshrc
%source $rc
%unset rc
%echo rwsh v
%version
%echo $nl
