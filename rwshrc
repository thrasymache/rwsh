%set MAX_NESTING 9
%function \ {%nop}
%function # {%nop}

# set up environment
%importenv_preserve
%global OLD_ERRNO /
%global REGEX /
%global SELECT $HOME
%global TEMP1 /
%global TEMP2 /
%selection_set SELECT /
%set FIGNORE .*

# alias builtins
%function . {%source $*}
%function af {rwsh.argfunction}
%function echo {%echo $*; %newline}
%function elif {%else_if $* {rwsh.argfunction}}
%function else {%else {rwsh.argfunction}}
%function exit {%exit}
%function fn {%function $1 $*2 {rwsh.argfunction}; %set TEMP1 $?; %if %test_equal $TEMP1 1 {echo cannot set paths as functions}; %else_if %test_equal $TEMP1 2 {echo cannot set builtins as functions}; %else_if %test_equal $TEMP1 3 {echo cannot set argfunctions in executable map}; %else_if %test_equal $TEMP1 4 {echo function did not exist to be erased}; %else {%return $TEMP1}}
%function if {%if $* {rwsh.argfunction}}
%function if_only {%if $* {rwsh.argfunction}; %else}
%function if_only_not {%if $*; %else {rwsh.argfunction}}
%function printenv {%printenv $*}
%function setf {%set TEMP1 $1; %set TEMP2 $2; %if %var_exists $TEMP1 {%set $TEMP1 $TEMP2}; %else {%global $TEMP1 $TEMP2}}
%function which {%set TEMP1 $1; %which_executable $TEMP1 {rwsh.argfunction}; %if %test_equal $? 0; %else {echo no $TEMP1}}
%function while {%while $* {rwsh.argfunction}}

# selection commands
%function cat {%selection_set SELECT $1; /bin/cat @$SELECT}
%function cd {%selection_set SELECT $1; %cd @$SELECT; %selection_set SELECT /}
%function cp {%selection_set SELECT $1; /bin/cp @$SELECT $2}
%function cvs {%selection_set SELECT $2; /usr/bin/cvs $1 @$SELECT}
%function grep {%set REGEX $1; %selection_set SELECT $2; /usr/bin/grep $REGEX @$SELECT}
%function regrep {%selection_set SELECT $1; /usr/bin/grep $REGEX @$SELECT}
%function ls {%selection_set SELECT $1; %ls @$SELECT}
%function less {%selection_set SELECT $1; /usr/bin/less @$SELECT}
%function set {%set $1 $2 $*3}
%function vi {%selection_set SELECT $1; /usr/bin/vi @$SELECT}
%function vim {%selection_set SELECT $1; /usr/bin/vim @$SELECT}
%function wc {%selection_set SELECT $1; /usr/bin/wc @$SELECT}
%function unselect {%set SELECT $CWD; %selection_set SELECT /}

# internal functions
%function rwsh.autofunction {%set TEMP1 $1; if_only %autofunction $TEMP1 \$* {%echo added $TEMP1 to executable map; %newline}}
%function rwsh.arguments_for_argfunction {%echo cannot specify arguments for $1 directly; %newline; %return -1}
%function rwsh.binary_not_found {%echo $1 : could not run binary; %newline; %return -1}
%function rwsh.excessive_nesting {%newline; %echo function exceeded MAX_NESTING ( $MAX_NESTING ). call stack: $*; %newline}
%function rwsh.mismatched_brace {%echo mismatched brace: $1; %newline; %return -1}
%function rwsh.multiple_argfunctions {%echo multiple argfunctions not supported at this time; %newline; %return -1}
%function rwsh.prompt {%echo $SELECT \$}
%function rwsh.selection_not_found {%echo no file matching pattern $1; %set TEMP1 $2; if_only_not %test_equal $1 $2 {%echo \ for selection $TEMP1}; %newline}
%function rwsh.shutdown {%newline}
%function rwsh.unreadable_dir {%echo cannot read directory $1; %newline}
%function rwsh.vars {%internal_vars; %newline; echo HOME $HOME; echo REGEX $REGEX; echo SELECT $SELECT}

# misc
%function ! {if $* {%return 1}; else {%return 0}}
%function and {%if %return 1; %stepwise $* {%else_if_not $*}; %else}
%function or {%if %return 1; %stepwise $* {%else_if $*}; %else}
%function st {/bin/bash /usr/bin/test_rwsh}

# final setup and individual configuration
%selection_set rc $HOME /.rwshrc
%source $rc
%unset rc
%function rwsh.after_command {%set TEMP1 $?; %set TEMP2 $1; %if_errno {echo ERRNO is set to $ERRNO; %set OLD_ERRNO $ERRNO; %unset ERRNO}; if_only_not %test_equal $TEMP1 0 {echo $TEMP2 returned $TEMP1}}
%echo rwsh v
%version
%newline
